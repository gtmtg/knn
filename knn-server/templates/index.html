<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>knn</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}"></script>

    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col-9">
                    <canvas id="main_canvas" width="640" height="480"></canvas>
                    <br>
                    <button id="toggle"></button>
                    <button id="clear" onclick="handle_clear_boxes()">Clear Boxes</button>
                    <ol id="results"></ol>
                </div>
                <div class="col-3">
                    <div id="stats" style="display: none;">
                        <b>Performance</b>
                        <section id="progress">
                            <div id="text"></div>
                            <progress id="bar"/>
                        </section>

                        <section id="dpi">
                            <div id="text"></div>
                            <progress id="bar"/>
                        </section>

                        <section id="ips">
                            <div id="text"></div>
                            <progress id="bar"/>
                        </section>

                        <section id="dps">
                            <div id="text"></div>
                            <progress id="bar"/>
                        </section>

                        <section id="piechart"></section>
                    </div>
                    <div id="workers" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='kmath.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='klabel.js') }}"></script>
    <script type="text/javascript">
        const server_url = "";
        const poll_interval = 500;  // ms
        const image_url_prefix = "https://storage.googleapis.com/mihir-knn/";
        const images = [
            "images/val2017/000000050811.jpg",
            "images/val2017/000000230983.jpg",
            "images/val2017/000000038118.jpg",
            "images/val2017/000000001584.jpg",
            "images/val2017/000000213593.jpg",
        ];

        let running = false;
        let poll;

        let prev_stats = {};
        let prev_workers = {};

        var labeler = new ImageLabeler;

        const set_running = (data) => {
            running = data.running;
            $("#toggle").html(running ? "Stop" : "Start");

            if (running) {
                $("#results").empty();
                $("#stats").show();
                $("#workers").show();
                poll = setInterval(
                    () => $.getJSON(server_url + "/results", display_results),
                    poll_interval
                );
            } else {
                prev_stats = {};
                prev_workers = {};
                clearInterval(poll);
            }
        };

        const fixed = (x, n) => {
            const p = Math.pow(10, n);
            return Math.trunc(x * p) / p;
        };

        const make_derivative = (cur, prev, key, fn) => {
            cur[key] = 1000 * (fn(cur) - fn(prev)) / (cur.ts - prev.ts);
            if (key in prev) {
                cur[key] = (prev[key] + cur[key]) / 2;
            }
        }

        google.charts.load('current', {'packages':['corechart']});

        const update_stats = (stats) => {
            stats.ts = (new Date()).getTime();
            if (!$.isEmptyObject(prev_stats)) {
                // Progress
                $("#stats #progress #text").html(`Processed ${stats.num_processed}, skipped ${stats.num_skipped} of ${stats.num_total} for $${fixed(stats.cost, 10)}`);
                $("#stats #progress #bar").attr({value: stats.num_processed + stats.num_skipped, max: stats.num_total});

                // $/image
                let dpi = stats.num_processed === 0 ? 0 : (stats.cost / stats.num_processed);
                $("#stats #dpi #text").html(`$${fixed(dpi, 10)}/image`);
                $("#stats #dpi #bar").attr({value: dpi, max: 0.0002});

                // Images/second
                make_derivative(stats, prev_stats, 'ips', (s) => s.num_processed);
                $("#stats #ips #text").html(`${fixed(stats.ips, 4)} images/s`);
                $("#stats #ips #bar").attr({value: stats.ips, max: 50});

                // $/second
                make_derivative(stats, prev_stats, 'dps', (s) => s.cost);
                $("#stats #dps #text").html(`$${fixed(stats.dps, 10)}/s`);
                $("#stats #dps #bar").attr({value: stats.dps, max: 0.002});

                // time breakdown
                var data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['Cloud Run Overhead (s)', stats.total_time - stats.gcr_time],
                    ['I/O (s)',      stats.gcr_time - stats.compute_time],
                    ['Compute (s)',  stats.compute_time],
                ]);

                var options = {
                  title: 'Average Request Breakdown',
                  legend: 'none'
                };

                var chart = new google.visualization.PieChart(document.getElementById('piechart'));

                chart.draw(data, options);
            }
            prev_stats = stats;
        }

        const update_workers = (workers) => {
            let raw_workers = {...workers};
            workers.ts = (new Date()).getTime();

            let html = '<b>Workers:</b>';
            for (const worker in raw_workers) {
                console.log(worker)
                if (worker in prev_workers) {
                    make_derivative(workers, prev_workers, worker + '_ips', (w) => w[worker]);
                } else {
                    workers[worker + '_ips'] = raw_workers[worker];
                }
                worker_ips = workers[worker + '_ips'];
                html += `<section><div>W${worker}: ${fixed(worker_ips, 4)} images/s</div><progress value="${worker_ips}" max="2"/></section>`;
            }
            $("#workers").html(html);

            prev_workers = workers;
        }

        const display_results = (data) => {
            if (running && data.running) {
                let result_html = "";
                for (const result of data.results) {
                    result_html += `<li>${result}</li>`;
                }
                $("#results").html(result_html);
                update_stats(data.stats);
                update_workers(data.workers);
            } else {
                set_running({running: false});
            }
        }

        $("#toggle").click(() => {
            let annotations = labeler.get_annotations()[labeler.get_current_frame_num()].annotations;
            let payload = {};
            if (annotations.length === 1) {
                let bbox = annotations[0].bbox;
                let source_image = labeler.get_current_frame().source_image;
                let patch = [
                    source_image.naturalWidth  * bbox.bmin.x, // x1
                    source_image.naturalHeight * bbox.bmin.y, // y1
                    source_image.naturalWidth  * bbox.bmax.x, // x2
                    source_image.naturalHeight * bbox.bmax.y  // y2
                ];
                payload = {
                    image: images[labeler.get_current_frame_num()],
                    patch
                };
            }

            $("#toggle").html("...");
            $.ajax({
                url: server_url + "/toggle",
                type: "POST",
                data: JSON.stringify(payload),
                contentType: "application/json",
                success: set_running,
                error: () => $("#toggle").html(running ? "Stop" : "Start"),
            });
        });

        $(window).on('load', () => {
            $.get(server_url + "/running", set_running);
        });

        var main_canvas = document.getElementById('main_canvas');
        labeler.init(main_canvas);

        var image_data = [];

        for (const image of images) {
            var data = new ImageData;
            data.source_url = image_url_prefix + image;
            image_data.push(data);
        }

        labeler.load_image_stack(image_data);

        labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_EXTREME_POINTS_BBOX);

        function handle_clear_boxes() {
            labeler.clear_boxes();
        }

        window.addEventListener("keydown", function(e) {
            e.preventDefault();
            labeler.handle_keydown(e);
        });

        window.addEventListener("keyup", function(e) {
            e.preventDefault();
            labeler.handle_keyup(e);
        });
    </script>

</html>
