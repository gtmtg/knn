<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>knn</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}"></script>

    </head>

    <body>
        <div class="container">
            <div class="row">
                <div class="col-9">
                    <canvas id="main_canvas" width="640" height="605"></canvas>
                    <br>
                    <button id="toggle"></button>
                    <button id="clear" onclick="handle_clear_boxes()">Clear Boxes</button>
                    <ol id="results"></ol>
                </div>
                <div class="col-3" id="stats" style="display: none;">
                    <b>Performance</b>
                    <section id="progress">
                        <div id="text"></div>
                        <progress id="bar"/>
                    </section>

                    <section id="dpi">
                        <div id="text"></div>
                        <progress id="bar"/>
                    </section>

                    <section id="ips">
                        <div id="text"></div>
                        <progress id="bar"/>
                    </section>

                    <section id="dps">
                        <div id="text"></div>
                        <progress id="bar"/>
                    </section>

                    <section id="piechart"></section>
                </div>
            </div>
        </div>
    </body>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='kmath.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='klabel.js') }}"></script>
    <script type="text/javascript">
        const server_url = "http://localhost:5000";
        const poll_interval = 500;  // ms

        let running = false;
        let poll;

        let prev_stats = undefined;

        var labeler = new ImageLabeler;

        const set_running = (data) => {
            running = data.running;
            $("#toggle").html(running ? "Stop" : "Start");

            if (running) {
                $("#results").empty();
                $("#stats").show();
                poll = setInterval(
                    () => $.getJSON(server_url + "/results", display_results),
                    poll_interval
                );
            } else {
                $("#stats").hide();
                clearInterval(poll);
            }
        };

        const make_derivative = (stats, key, fn) => {
            stats[key] = 1000 * (fn(stats) - fn(prev_stats)) / (stats.ts - prev_stats.ts);
            if (prev_stats[key]) {
                stats[key] = (prev_stats[key] + stats[key]) / 2;
            }
        }

        google.charts.load('current', {'packages':['corechart']});

        const update_stats = (stats) => {
            stats.ts = (new Date()).getTime();
            if (prev_stats) {
                // Progress
                $("#stats #progress #text").html(`Processed ${stats.num_processed}, skipped ${stats.num_skipped} of ${stats.num_total} for $${stats.cost === 0 ? 0 : stats.cost.toFixed(10)}`);
                $("#stats #progress #bar").attr({value: stats.num_processed + stats.num_skipped, max: stats.num_total});

                // $/image
                let dpi = stats.num_processed === 0 ? 0 : (stats.cost / stats.num_processed);
                $("#stats #dpi #text").html(`$${dpi === 0 ? 0 : dpi.toFixed(10)}/image`);
                $("#stats #dpi #bar").attr({value: dpi, max: 0.0002});

                // Images/second
                make_derivative(stats, 'ips', (s) => s.num_processed);
                $("#stats #ips #text").html(`${stats.ips === 0 ? 0 : stats.ips.toFixed(4)} images/second`);
                $("#stats #ips #bar").attr({value: stats.ips, max: 50});

                // $/second
                make_derivative(stats, 'dps', (s) => s.cost);
                $("#stats #dps #text").html(`$${stats.dps === 0 ? 0 : stats.dps.toFixed(10)}/second`);
                $("#stats #dps #bar").attr({value: stats.dps, max: 0.002});

                // time breakdown
                var data = google.visualization.arrayToDataTable([
                    ['', ''],
                    ['Cloud Run Overhead (s)', stats.total_time - stats.gcr_time],
                    ['I/O (s)',      stats.gcr_time - stats.compute_time],
                    ['Compute (s)',  stats.compute_time],
                ]);

                var options = {
                  title: 'Average Request Breakdown',
                  legend: 'none'
                };

                var chart = new google.visualization.PieChart(document.getElementById('piechart'));

                chart.draw(data, options);
            }
            prev_stats = stats;
        }


        const display_results = (data) => {
            if (running) {
                let result_html = "";
                for (const result of data.results) {
                    result_html += `<li>${result}</li>`;
                }
                $("#results").html(result_html);
                update_stats(data.stats);
            }
        }

        $("#toggle").click(() => {
            let annotations = labeler.get_annotations()[0].annotations;
            let payload = {};
            if (annotations.length === 1) {
                let bbox = annotations[0].bbox;
                let patch = [
                    640 * bbox.bmin.x, // x1
                    605 * bbox.bmin.y, // y1
                    640 * bbox.bmax.x, // x2
                    605 * bbox.bmax.y  // y2
                ];
                payload = {
                    image: "images/val2017/000000050811.jpg",
                    patch
                };
            }

            $("#toggle").html("...");
            $.ajax({
                url: server_url + "/toggle",
                type: "POST",
                data: JSON.stringify(payload),
                contentType: "application/json",
                success: set_running,
                error: () => $("#toggle").html(running ? "Stop" : "Start"),
            });
        });

        $(window).on('load', () => {
            $.get(server_url + "/running", set_running);
        });

        var main_canvas = document.getElementById('main_canvas');
        labeler.init(main_canvas);

        // set the data source
        var filenames = ["https://storage.googleapis.com/mihir-knn/images/val2017/000000050811.jpg"];

        var image_data = [];

        for (var i=0; i<filenames.length; i++) {
            var data = new ImageData;
            data.source_url = filenames[i];
            image_data.push(data);
        }

        labeler.load_image_stack(image_data);

        labeler.set_annotation_mode(Annotation.ANNOTATION_MODE_EXTREME_POINTS_BBOX);

        function handle_clear_boxes() {
            labeler.clear_boxes();
        }
    </script>

</html>
